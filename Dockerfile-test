FROM sso-frontend

RUN npm install phantomjs slimerjs casperjs coffee-script
RUN apt-get install -y postgresql libpq-dev

ENV PHANTOMJS_EXECUTABLE /opt/app/node_modules/phantomjs/bin/phantomjs
ENV FAKE_TESTING true
ENV DEBUG true
ENV PUBTKT_PUBKEY /opt/app/docker/test-pubtktkey
ENV SAML_PUBKEY /opt/app/docker/test-samlkey

ENV DB_HOST ''
ENV DB_USER ''
ENV DB_PASSWORD '' 

USER postgres
RUN service postgresql start && psql --command 'CREATE USER root;' && createdb -O root login
USER root

COPY docker/test-start.sh /opt/app/docker/test-start.sh
COPY docker/test-supervisord.conf /etc/supervisor/test-supervisord.conf

RUN node_modules/coffee-script/bin/coffee -c casper_smoketests/*.coffee
RUN rm casper_smoketests/*.coffee

CMD bash -C '/opt/app/docker/test-start.sh'